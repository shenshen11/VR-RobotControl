# ğŸ‰ é‡å¤§çªç ´ï¼æ‰¾åˆ°æ ¹æœ¬åŸå› äº†ï¼

## ğŸ“‹ é—®é¢˜æ€»ç»“

ä½ æŠ¥å‘Šçš„é—®é¢˜ï¼š
- âœ… ç«‹æ–¹ä½“æ˜¯ç«‹ä½“çš„ï¼ˆWebXR ç«‹ä½“æ¸²æŸ“æ­£å¸¸ï¼‰
- âœ… å·¦çœ¼çœ‹å·¦è¾¹é¢æ¿ï¼Œå³çœ¼çœ‹å³è¾¹é¢æ¿ï¼ˆå›¾å±‚ç³»ç»Ÿå·¥ä½œï¼‰
- âŒ **ä¸¤ä¸ªé¢æ¿éƒ½æ˜¾ç¤ºçº¢è‰² "LEFT EYE"**ï¼ˆè§†é¢‘æµé—®é¢˜ï¼‰
- âŒ **è§†é¢‘çœ‹èµ·æ¥æ˜¯ 2D å¹³é¢**ï¼ˆæ˜¾ç¤ºæ–¹å¼é—®é¢˜ï¼‰

---

## ğŸ” æ ¹æœ¬åŸå› ï¼ˆé€šè¿‡ Web æœç´¢å‘ç°ï¼‰

### å‘ç° 1: VRCamera çˆ¶ç›¸æœºé…ç½®ç¼ºå¤±

**æ¥æº**: Three.js å®˜æ–¹è®ºå›
- https://discourse.threejs.org/t/layers-and-webxr/17751/5

**å…³é”®ä¿¡æ¯**ï¼š
> When using WebXR, layer 1 and 2 are reserved for XR rendering. When assigning objects just to layer 1, they are only rendered for the left eye. Layer 2 is assigned to the right eye. Objects on the default layer 0 are rendered in both views.

**è§£å†³æ–¹æ¡ˆ**ï¼ˆæ¥è‡ªè®ºå›ç”¨æˆ· jrjdavidsonï¼‰ï¼š
```javascript
const VRCamera = renderer.xr.getCamera();
VRCamera.layers.enable(3);  // â† å…³é”®ï¼šå¿…é¡»é…ç½®çˆ¶ç›¸æœºï¼
for (const camera of VRCamera.cameras) {
    camera.layers.enable(3);
}
```

**æˆ‘ä»¬ä¹‹å‰çš„é”™è¯¯**ï¼š
```javascript
// âŒ åªé…ç½®äº†å­ç›¸æœºï¼Œæ²¡æœ‰é…ç½®çˆ¶ç›¸æœº
xrCamera.cameras[0].layers.enable(1);
xrCamera.cameras[1].layers.enable(2);
```

**æ­£ç¡®çš„åšæ³•**ï¼š
```javascript
// âœ… å¿…é¡»åŒæ—¶é…ç½®çˆ¶ç›¸æœºå’Œå­ç›¸æœº
xrCamera.layers.enable(0);
xrCamera.layers.enable(1);
xrCamera.layers.enable(2);

xrCamera.cameras[0].layers.enable(0);
xrCamera.cameras[0].layers.enable(1);

xrCamera.cameras[1].layers.enable(0);
xrCamera.cameras[1].layers.enable(2);
```

### å‘ç° 2: WebRTC è½¨é“æ¥æ”¶é¡ºåºä¸ç¡®å®š

**æ¥æº**: Stack Overflow å’Œ GitHub è®¨è®º
- https://stackoverflow.com/questions/66243915/how-to-get-multiple-streams-from-webrtc-peerconnection
- https://github.com/pion/webrtc/discussions/2906

**é—®é¢˜**ï¼š
å³ä½¿æœåŠ¡å™¨æŒ‰ç…§ "å·¦çœ¼ â†’ å³çœ¼" çš„é¡ºåºæ·»åŠ è½¨é“ï¼Œå®¢æˆ·ç«¯æ¥æ”¶æ—¶é¡ºåºå¯èƒ½ä¸åŒã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
é€šè¿‡åˆ†æè§†é¢‘å†…å®¹ï¼ˆé¢œè‰²ï¼‰æ¥è¯†åˆ«å·¦å³çœ¼ï¼Œè€Œä¸æ˜¯ä¾èµ–æ¥æ”¶é¡ºåºã€‚

---

## ğŸ› ï¸ å·²å®Œæˆçš„ä¿®å¤

### ä¿®å¤ 1: é…ç½® VRCamera çˆ¶ç›¸æœº

**æ–‡ä»¶**: `src/vr-scene.js`

**ä¿®æ”¹**: `configureStereoLayers()` æ–¹æ³•

```javascript
configureStereoLayers() {
    const xrCamera = this.renderer.xr.getCamera();
    
    // ğŸ”‘ å…³é”®ä¿®å¤ï¼šå¿…é¡»åŒæ—¶é…ç½®çˆ¶ç›¸æœºå’Œå­ç›¸æœº
    
    // 1. é…ç½® VRCamera æœ¬èº«ï¼ˆçˆ¶ç›¸æœºï¼‰
    xrCamera.layers.disableAll();
    xrCamera.layers.enable(0);  // åœºæ™¯
    xrCamera.layers.enable(1);  // å·¦çœ¼è§†é¢‘
    xrCamera.layers.enable(2);  // å³çœ¼è§†é¢‘
    console.log('   - VRCamera (çˆ¶) -> å›¾å±‚ 0 + 1 + 2');
    
    // 2. é…ç½®å·¦çœ¼ç›¸æœº
    xrCamera.cameras[0].layers.disableAll();
    xrCamera.cameras[0].layers.enable(0);
    xrCamera.cameras[0].layers.enable(1);
    console.log('   - å·¦çœ¼ç›¸æœº -> å›¾å±‚ 0 + 1');
    
    // 3. é…ç½®å³çœ¼ç›¸æœº
    xrCamera.cameras[1].layers.disableAll();
    xrCamera.cameras[1].layers.enable(0);
    xrCamera.cameras[1].layers.enable(2);
    console.log('   - å³çœ¼ç›¸æœº -> å›¾å±‚ 0 + 2');
}
```

### ä¿®å¤ 2: æ™ºèƒ½è§†é¢‘æµè¯†åˆ«

**æ–‡ä»¶**: `main.js`

**åŠŸèƒ½**ï¼š
- æ¥æ”¶ä¸¤ä¸ªè§†é¢‘æµåï¼Œåˆ†ææ¯ä¸ªæµçš„é¢œè‰²
- çº¢è‰² (R > B) â†’ å·¦çœ¼
- è“è‰² (B > R) â†’ å³çœ¼
- è‡ªåŠ¨æ­£ç¡®åˆ†é…åˆ° `leftTexture` å’Œ `rightTexture`

**ä»£ç **ï¼š
```javascript
async function identifyEyeStreams(stream1, stream2) {
    // åˆ›å»ºä¸´æ—¶ video å…ƒç´ 
    // ç»˜åˆ¶åˆ° canvas
    // åˆ†æå¹³å‡ RGB å€¼
    // åˆ¤æ–­å“ªä¸ªæ˜¯å·¦çœ¼ï¼Œå“ªä¸ªæ˜¯å³çœ¼
}
```

### ä¿®å¤ 3: å…¨è§†é‡è§†é¢‘æ˜¾ç¤º

**æ–‡ä»¶**: `src/vr-scene.js`

**æ”¹åŠ¨**ï¼š
- åˆ›å»ºå¤§çš„å¹³é¢å±å¹•ï¼Œå¡«æ»¡ 90Â° è§†åœºè§’
- è·ç¦»ç›¸æœº 1 ç±³
- ç¦ç”¨æ·±åº¦æµ‹è¯•ï¼Œä½œä¸ºèƒŒæ™¯æ¸²æŸ“

**æ•ˆæœ**ï¼š
- è§†é¢‘ä¸å†æ˜¯ç©ºé—´ä¸­çš„"ç”µè§†å±å¹•"
- è§†é¢‘å¡«æ»¡æ•´ä¸ªè§†é‡
- å°±åƒçœŸçš„åœ¨æœºå™¨äººçœ¼ç›é‡Œçœ‹ä¸€æ ·

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: å¯åŠ¨è™šæ‹Ÿæœºå™¨äººï¼ˆæµ‹è¯•å›¾æ¡ˆæ¨¡å¼ï¼‰

```bash
cd virtual-robot
python main.py --test-pattern
```

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ… è§†é¢‘è½¨é“åˆ›å»º: left çœ¼, 30 fps, æ¨¡å¼: æµ‹è¯•å›¾æ¡ˆ
âœ… è§†é¢‘è½¨é“åˆ›å»º: right çœ¼, 30 fps, æ¨¡å¼: æµ‹è¯•å›¾æ¡ˆ
ğŸ“¹ æ·»åŠ å·¦çœ¼è½¨é“: ID=xxx
ğŸ“¹ æ·»åŠ å³çœ¼è½¨é“: ID=xxx
âœ… å·²æ·»åŠ  2 ä¸ªè§†é¢‘è½¨é“ï¼ˆå·¦çœ¼ + å³çœ¼ï¼‰ï¼Œæ¨¡å¼: æµ‹è¯•å›¾æ¡ˆ
   âš ï¸  æ³¨æ„: WebRTC è½¨é“æ¥æ”¶é¡ºåºå¯èƒ½ä¸ç¡®å®šï¼
```

### æ­¥éª¤ 2: åˆ·æ–° PICO VR æµè§ˆå™¨

è®¿é—®: `https://172.20.10.2:3000`

### æ­¥éª¤ 3: æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ï¼ˆè¿›å…¥ VR å‰ï¼‰

**åº”è¯¥çœ‹åˆ°**ï¼š
```
ğŸ“¹ æ”¶åˆ°è§†é¢‘è½¨é“ 1: xxx
   - Track label: xxx
   - Stream ID: xxx
ğŸ“¹ æ”¶åˆ°è§†é¢‘è½¨é“ 2: xxx
   - Track label: xxx
   - Stream ID: xxx
ğŸ” æ­£åœ¨è¯†åˆ«å·¦å³çœ¼è§†é¢‘æµ...
ğŸ¨ è§†é¢‘æµé¢œè‰²åˆ†æ:
   - æµ 1: R=xxx, G=xxx, B=xxx
   - æµ 2: R=xxx, G=xxx, B=xxx
âœ… è¯†åˆ«ç»“æœ: æµ1=å·¦çœ¼(çº¢), æµ2=å³çœ¼(è“)
   æˆ–
âœ… è¯†åˆ«ç»“æœ: æµ1=å³çœ¼(è“), æµ2=å·¦çœ¼(çº¢)
âœ… åŒç›®è§†é¢‘æµå·²è¿æ¥ï¼å¯ä»¥è¿›å…¥ VR äº†
```

**å…³é”®æ£€æŸ¥ç‚¹**ï¼š
- âœ… å¿…é¡»çœ‹åˆ° "ğŸ¨ è§†é¢‘æµé¢œè‰²åˆ†æ"
- âœ… å¿…é¡»çœ‹åˆ° "âœ… è¯†åˆ«ç»“æœ"
- âœ… å¿…é¡»æ­£ç¡®è¯†åˆ«çº¢è‰²å’Œè“è‰²

### æ­¥éª¤ 4: è¿›å…¥ VR æ¨¡å¼

ç‚¹å‡» "ENTER VR"

**æ§åˆ¶å°åº”è¯¥æ˜¾ç¤º**ï¼š
```
ğŸ¥½ VR ä¼šè¯å·²å¯åŠ¨
ğŸ¥½ é…ç½®ç«‹ä½“å›¾å±‚...
ğŸ“· XR ç›¸æœºæ•°é‡: 2
   - VRCamera (çˆ¶) -> å›¾å±‚ 0 + 1 + 2  â† ğŸ”‘ å…³é”®ï¼
   - å·¦çœ¼ç›¸æœº -> å›¾å±‚ 0 + 1
   - å³çœ¼ç›¸æœº -> å›¾å±‚ 0 + 2
âœ… åŒç›®å›¾å±‚é…ç½®å®Œæˆ

ğŸ‘€ ç°åœ¨åº”è¯¥èƒ½çœ‹åˆ°ç«‹ä½“æ•ˆæœäº†ï¼
```

**å…³é”®æ£€æŸ¥ç‚¹**ï¼š
- âœ… å¿…é¡»çœ‹åˆ° "VRCamera (çˆ¶) -> å›¾å±‚ 0 + 1 + 2"
- âœ… XR ç›¸æœºæ•°é‡å¿…é¡»æ˜¯ 2

### æ­¥éª¤ 5: éªŒè¯ç«‹ä½“æ•ˆæœ

**æµ‹è¯•å›¾æ¡ˆæ¨¡å¼ä¸‹**ï¼š

1. **çå¼€åŒçœ¼**ï¼š
   - åº”è¯¥çœ‹åˆ°çº¢è‰²å’Œè“è‰²æ··åˆçš„ç”»é¢
   - æˆ–è€…çº¢è“äº¤æ›¿é—ªçƒ

2. **é—­ä¸Šå·¦çœ¼ï¼Œåªç”¨å³çœ¼çœ‹**ï¼š
   - åº”è¯¥åªçœ‹åˆ°è“è‰² "RIGHT EYE"

3. **é—­ä¸Šå³çœ¼ï¼Œåªç”¨å·¦çœ¼çœ‹**ï¼š
   - åº”è¯¥åªçœ‹åˆ°çº¢è‰² "LEFT EYE"

4. **è§†é‡èŒƒå›´**ï¼š
   - è§†é¢‘åº”è¯¥å¡«æ»¡æ•´ä¸ªè§†é‡
   - ä¸åº”è¯¥çœ‹åˆ°ç©ºé—´ä¸­çš„"å±å¹•è¾¹æ¡†"

---

## ğŸ“Š æˆåŠŸæ ‡å¿—

### âœ… è§†é¢‘æµè¯†åˆ«æˆåŠŸ

**æ§åˆ¶å°**ï¼š
```
âœ… è¯†åˆ«ç»“æœ: æµ1=å·¦çœ¼(çº¢), æµ2=å³çœ¼(è“)
```

**VR æ˜¾ç¤º**ï¼š
- å·¦çœ¼çœ‹åˆ°çº¢è‰²
- å³çœ¼çœ‹åˆ°è“è‰²

### âœ… å›¾å±‚é…ç½®æˆåŠŸ

**æ§åˆ¶å°**ï¼š
```
- VRCamera (çˆ¶) -> å›¾å±‚ 0 + 1 + 2
- å·¦çœ¼ç›¸æœº -> å›¾å±‚ 0 + 1
- å³çœ¼ç›¸æœº -> å›¾å±‚ 0 + 2
```

### âœ… ç«‹ä½“è§†è§‰æˆåŠŸ

**çœŸå®åœºæ™¯æ¨¡å¼ä¸‹**ï¼ˆåœæ­¢ `--test-pattern`ï¼‰ï¼š
- å·¦å³çœ¼çœ‹åˆ°ç•¥å¾®ä¸åŒçš„ç”»é¢
- æœ‰æ˜æ˜¾çš„æ·±åº¦æ„Ÿ
- ç‰©ä½“æœ‰ç«‹ä½“æ„Ÿï¼ˆä¸æ˜¯å¹³é¢ï¼‰

---

## ğŸ”§ å¦‚æœä»ç„¶æœ‰é—®é¢˜

### é—®é¢˜ A: ä»ç„¶åªçœ‹åˆ°çº¢è‰²

**å¯èƒ½åŸå› **ï¼š
1. è§†é¢‘æµè¯†åˆ«å¤±è´¥
2. ä¸¤ä¸ªæµéƒ½æ˜¯å·¦çœ¼æµï¼ˆæœåŠ¡å™¨ç«¯é—®é¢˜ï¼‰

**æ£€æŸ¥**ï¼š
- æŸ¥çœ‹æ§åˆ¶å°çš„ "ğŸ¨ è§†é¢‘æµé¢œè‰²åˆ†æ"
- å¦‚æœä¸¤ä¸ªæµçš„ R å€¼éƒ½å¾ˆé«˜ â†’ æœåŠ¡å™¨ç«¯é—®é¢˜
- å¦‚æœè¯†åˆ«ç»“æœé”™è¯¯ â†’ å®¢æˆ·ç«¯è¯†åˆ«é€»è¾‘é—®é¢˜

**è§£å†³**ï¼š
```bash
# é‡å¯è™šæ‹Ÿæœºå™¨äººæœåŠ¡å™¨
cd virtual-robot
python main.py --test-pattern
```

### é—®é¢˜ B: æ§åˆ¶å°æ²¡æœ‰æ˜¾ç¤º "VRCamera (çˆ¶)"

**å¯èƒ½åŸå› **ï¼š
ä»£ç æ²¡æœ‰æ›´æ–°

**è§£å†³**ï¼š
1. ç¡®è®¤å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼š`npm run dev`
2. å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+Shift+Rï¼‰
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜

### é—®é¢˜ C: è§†é¢‘ä»ç„¶æ˜¯å¹³é¢

**å¯èƒ½åŸå› **ï¼š
1. æœºå™¨äººç›¸æœºçš„ IPD è®¾ç½®ä¸æ­£ç¡®
2. å·¦å³çœ¼å›¾åƒå®Œå…¨ç›¸åŒ

**æ£€æŸ¥**ï¼š
```bash
# ä¿å­˜ç›¸æœºå›¾åƒåˆ°æ–‡ä»¶
cd virtual-robot
python debug_camera.py

# æŸ¥çœ‹ debug_output/stereo_comparison.png
# å·¦å³çœ¼å›¾åƒåº”è¯¥ç•¥æœ‰ä¸åŒ
```

---

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### WebXR å›¾å±‚ç³»ç»Ÿ

**Three.js ä¸­çš„å›¾å±‚**ï¼š
- å›¾å±‚ 0ï¼šé»˜è®¤å›¾å±‚ï¼Œæ‰€æœ‰ç‰©ä½“é»˜è®¤åœ¨è¿™ä¸ªå›¾å±‚
- å›¾å±‚ 1ï¼šWebXR ä¸­ä¿ç•™ç»™å·¦çœ¼
- å›¾å±‚ 2ï¼šWebXR ä¸­ä¿ç•™ç»™å³çœ¼
- å›¾å±‚ 3+ï¼šå¯ä»¥è‡ªç”±ä½¿ç”¨

**å…³é”®ç‚¹**ï¼š
1. ç‰©ä½“çš„å›¾å±‚å†³å®šäº†å®ƒåœ¨å“ªä¸ªå›¾å±‚ä¸Š
2. ç›¸æœºçš„å›¾å±‚å†³å®šäº†å®ƒèƒ½çœ‹åˆ°å“ªäº›å›¾å±‚
3. **åœ¨ WebXR ä¸­ï¼Œå¿…é¡»åŒæ—¶é…ç½®çˆ¶ç›¸æœºå’Œå­ç›¸æœº**

### è§†é¢‘æµè¯†åˆ«ç®—æ³•

```javascript
// 1. åˆ›å»ºä¸´æ—¶ video å…ƒç´ 
const video = document.createElement('video');
video.srcObject = stream;
video.play();

// 2. ç­‰å¾…è§†é¢‘åŠ è½½
await waitForVideoReady(video);

// 3. ç»˜åˆ¶åˆ° canvas
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
ctx.drawImage(video, 0, 0);

// 4. è·å–åƒç´ æ•°æ®
const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

// 5. è®¡ç®—å¹³å‡é¢œè‰²
const avgColor = analyzeColor(imageData.data);

// 6. åˆ¤æ–­å·¦å³çœ¼
if (avgColor.r > avgColor.b) {
    // çº¢è‰² â†’ å·¦çœ¼
} else {
    // è“è‰² â†’ å³çœ¼
}
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### å¦‚æœæµ‹è¯•å›¾æ¡ˆæˆåŠŸ

1. **åœæ­¢æµ‹è¯•å›¾æ¡ˆæ¨¡å¼**ï¼š
   ```bash
   # æŒ‰ Ctrl+C åœæ­¢
   # é‡æ–°å¯åŠ¨ï¼ˆä¸å¸¦ --test-patternï¼‰
   cd virtual-robot
   python main.py
   ```

2. **åˆ·æ–°æµè§ˆå™¨**

3. **è¿›å…¥ VR**

4. **äº«å—çœŸå®çš„æœºå™¨äººè§†è§’ï¼**

### å¦‚æœä»ç„¶æœ‰é—®é¢˜

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´è¾“å‡ºï¼ˆç‰¹åˆ«æ˜¯é¢œè‰²åˆ†æå’Œå›¾å±‚é…ç½®éƒ¨åˆ†ï¼‰
2. è™šæ‹Ÿæœºå™¨äººæœåŠ¡å™¨çš„è¾“å‡º
3. ä½ åœ¨ VR ä¸­çœ‹åˆ°çš„å…·ä½“å†…å®¹
4. æ˜¯å¦çœ‹åˆ° "VRCamera (çˆ¶) -> å›¾å±‚ 0 + 1 + 2"

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **Three.js å®˜æ–¹è®ºå› - Layers and WebXR**
   - https://discourse.threejs.org/t/layers-and-webxr/17751

2. **Three.js å®˜æ–¹è®ºå› - æœåŠ¡å™¨æ¸²æŸ“ç«‹ä½“è§†é¢‘**
   - https://discourse.threejs.org/t/how-to-display-frames-already-rendered-in-the-server-and-transmitted-over-the-wire-as-images-stereoscopic-view-webxr/60382

3. **WebRTC å¤šè½¨é“é—®é¢˜**
   - https://stackoverflow.com/questions/66243915/how-to-get-multiple-streams-from-webrtc-peerconnection
   - https://github.com/pion/webrtc/discussions/2906

---

## ğŸ‰ æ€»ç»“

**æ ¸å¿ƒå‘ç°**ï¼š
1. **å¿…é¡»é…ç½® VRCamera çˆ¶ç›¸æœº** - è¿™æ˜¯ä¹‹å‰é—æ¼çš„å…³é”®æ­¥éª¤
2. **WebRTC è½¨é“é¡ºåºä¸ç¡®å®š** - éœ€è¦æ™ºèƒ½è¯†åˆ«
3. **è§†é¢‘æ˜¾ç¤ºæ–¹å¼** - éœ€è¦å¡«æ»¡è§†é‡

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… å·¦çœ¼çœ‹åˆ°çº¢è‰² "LEFT EYE"
- âœ… å³çœ¼çœ‹åˆ°è“è‰² "RIGHT EYE"
- âœ… è§†é¢‘å¡«æ»¡æ•´ä¸ªè§†é‡
- âœ… çœŸå®åœºæ™¯ä¸‹æœ‰ç«‹ä½“æ„Ÿ

**ç°åœ¨è¯·æµ‹è¯•å¹¶å‘Šè¯‰æˆ‘ç»“æœï¼** ğŸš€

