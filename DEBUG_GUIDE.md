# 🔍 VR 立体视觉调试指南

## 问题：看到相机数量是 2，但只看到 2D 平面

如果你在 VR 中看到：
- ✅ 控制台显示 "XR 相机数量: 2"
- ❌ 但只看到一个 2D 平面，没有立体效果
- ❌ 画面内容不清楚

这说明**立体图层配置正常**，但可能是以下问题之一：
1. 左右眼看到的是**相同的内容**（没有视差）
2. 视频流本身有问题
3. 机器人相机位置不对

---

## 🛠️ 调试工具

### 工具 1: 测试图案模式（推荐）

使用测试图案可以立即验证立体渲染是否工作。

**启动测试图案模式**：
```bash
cd virtual-robot

# 停止当前服务器（Ctrl+C）
# 然后用测试图案模式启动
python main.py --test-pattern
```

**预期效果**：
- 左眼应该看到：**红色背景 + "LEFT EYE" 文字**
- 右眼应该看到：**蓝色背景 + "RIGHT EYE" 文字**

**如果看到测试图案**：
- ✅ 说明立体渲染**完全正常**
- ✅ 问题在于真实场景的渲染
- 👉 继续使用工具 2 检查真实场景

**如果看不到测试图案**：
- ❌ 说明视频流传输有问题
- 👉 检查 WebRTC 连接状态
- 👉 查看虚拟机器人控制台是否有错误

---

### 工具 2: 保存相机图像到文件

这个工具会保存机器人相机看到的画面到文件，让你能在电脑上查看。

**运行调试工具**：
```bash
cd virtual-robot
python debug_camera.py
```

**输出文件**（在 `virtual-robot/debug_output/` 目录）：
1. `left_eye.png` - 左眼真实场景
2. `right_eye.png` - 右眼真实场景
3. `stereo_comparison.png` - 左右眼对比图
4. `test_left_eye.png` - 左眼测试图案（红色）
5. `test_right_eye.png` - 右眼测试图案（蓝色）
6. `test_comparison.png` - 测试图案对比图

**检查这些图像**：

✅ **正常情况**：
- 真实场景图像应该显示 PyBullet 场景（地面、立方体等）
- 左右眼图像应该有**轻微的视差**（物体位置略有不同）
- 测试图案应该是红色和蓝色

❌ **异常情况**：
- 如果图像全黑 → 相机位置有问题
- 如果左右眼完全相同 → 瞳距（IPD）设置有问题
- 如果图像模糊或扭曲 → 渲染参数有问题

---

## 🎯 分步调试流程

### 步骤 1: 验证立体渲染管道

```bash
# 1. 启动测试图案模式
cd virtual-robot
python main.py --test-pattern

# 2. 在 VR 中进入 VR 模式
# 3. 检查是否看到红色（左眼）和蓝色（右眼）
```

**结果判断**：
- ✅ 看到红蓝测试图案 → 立体渲染正常，跳到步骤 2
- ❌ 看不到或看到相同颜色 → 图层配置有问题，查看下方"图层问题排查"

---

### 步骤 2: 检查真实场景渲染

```bash
# 1. 保存相机图像
cd virtual-robot
python debug_camera.py

# 2. 打开 debug_output 目录
# 3. 查看 stereo_comparison.png
```

**检查要点**：
- 图像是否清晰？
- 左右眼是否有视差？
- 能看到场景中的物体吗？

---

### 步骤 3: 启动真实场景模式

```bash
# 停止测试图案模式（Ctrl+C）
# 启动正常模式
cd virtual-robot
python main.py

# 在 VR 中刷新页面并进入 VR
```

**预期效果**：
- 应该看到 PyBullet 场景
- 地面、立方体、机器人等
- 有明显的 3D 深度感

---

## 🔧 常见问题排查

### 问题 1: 测试图案也看不到

**可能原因**：
- WebRTC 连接失败
- 视频流没有传输

**排查步骤**：
1. 检查虚拟机器人控制台：
   ```
   📹 left 眼已发送 100 帧 (测试图案)
   📹 right 眼已发送 100 帧 (测试图案)
   ```
   如果没有这些信息，说明视频流没有发送

2. 检查浏览器控制台：
   ```
   📹 收到视频轨道 1/2
   📹 收到视频轨道 2/2
   ✅ 双目视频流已连接！
   ```
   如果没有这些信息，说明 WebRTC 连接有问题

3. 检查 WebRTC 连接状态：
   ```
   🔗 WebRTC 连接状态: connected
   ```

---

### 问题 2: 测试图案正常，但真实场景是黑屏

**可能原因**：
- 相机位置不对（在地下或看向空白区域）
- PyBullet 场景没有物体
- 渲染器有问题

**解决方案**：

1. **启动 PyBullet GUI 查看场景**：
   ```bash
   cd virtual-robot
   python main.py --gui
   ```
   这样你可以看到 PyBullet 的 3D 窗口，确认场景中有物体

2. **检查相机位置**：
   编辑 `virtual-robot/robot_sim.py`，确认机器人头部位置合理（应该在地面以上）

3. **保存图像检查**：
   ```bash
   python debug_camera.py
   ```
   查看保存的图像是否有内容

---

### 问题 3: 左右眼图像完全相同（没有视差）

**可能原因**：
- 瞳距（IPD）设置为 0
- 左右眼相机位置计算错误

**解决方案**：

检查 `virtual-robot/main.py` 第 48-54 行：
```python
camera = StereoCamera(
    robot, 
    width=resolution[0], 
    height=resolution[1],
    fov=90,
    ipd=0.064  # ← 确保这个值不是 0
)
```

正常的 IPD 应该是 0.064（64mm）

---

### 问题 4: 图像模糊或拉伸

**可能原因**：
- 分辨率设置不对
- 视频纹理比例不对

**解决方案**：

1. **检查分辨率**：
   ```bash
   # 使用标准分辨率
   python main.py --width 640 --height 480
   ```

2. **检查浏览器控制台**：
   ```
   📹 左眼视频: 640x480
   📹 右眼视频: 640x480
   ```
   确保分辨率正确

---

## 📊 调试检查清单

使用这个清单逐项检查：

- [ ] 虚拟机器人服务器正在运行
- [ ] VR 客户端已连接（浏览器控制台显示 "✅ WebSocket 连接成功"）
- [ ] WebRTC 连接状态为 "connected"
- [ ] 收到 2 个视频轨道
- [ ] XR 相机数量为 2
- [ ] 双目图层配置完成
- [ ] 测试图案模式下能看到红蓝图案
- [ ] 保存的图像文件正常
- [ ] 真实场景模式下能看到 PyBullet 场景

---

## 💡 高级调试

### 查看详细日志

**虚拟机器人端**：
```bash
cd virtual-robot
python main.py --gui --test-pattern 2>&1 | tee debug.log
```

**浏览器端**：
1. 打开开发者工具（F12）
2. 切换到 Console 标签
3. 查看所有输出

### 降低分辨率测试

如果怀疑是性能问题：
```bash
python main.py --width 320 --height 240 --fps 15 --test-pattern
```

### 使用 GUI 模式

查看 PyBullet 场景：
```bash
python main.py --gui
```
这样你可以直接看到机器人和场景

---

## 📞 获取帮助

如果以上方法都无法解决问题，请提供：

1. **虚拟机器人控制台完整输出**
2. **浏览器控制台完整输出**
3. **`debug_output` 目录中的图像文件**
4. **问题描述**：
   - 你看到了什么？
   - 预期应该看到什么？
   - 测试图案模式是否正常？

---

**最后更新**: 2025-11-10

